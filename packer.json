{
  "description": "Builds images from the ingen-base-box template to use as base images for further customisation",
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",
    "digitalocean_token": "",
    "source_ami_trusty64": "ami-d16c9aa8",
    "_source_ami_readme": "https://cloud-images.ubuntu.com/locator/ec2/ search for eu-west-1 trusty hvm:ebs",
    "vagrant_box_path": "{{env `HOMEDRIVE`}}{{env `HOMEPATH`}}/.vagrant.d/boxes",
    "vagrant_cloud_token": null,
    "version": null
  },
  "builders": [
    {
      "name": "ingen-base-trusty64",
      "type": "virtualbox-ovf",
      "source_path": "{{user `vagrant_box_path`}}/ubuntu-VAGRANTSLASH-trusty64/14.04/virtualbox/box.ovf",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "ssh_wait_timeout": "30s",
      "shutdown_command": "echo 'packer' | sudo -S shutdown -P now",
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "1024"]
      ]
    },
    {
      "name": "ingen-jenkins-trusty64",
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "ami_name": "ingen-base-trusty64-jenkins-slave-{{isotime \"2006-01-02T15-04-05MST\"}}",
      "ami_description": "Trusty64 Jenkins slave configured with https://github.com/ingenerator/ingen-base",
      "instance_type": "t2.large",
      "region": "eu-west-1",
      "source_ami": "{{user `source_ami_trusty64`}}",
      "ssh_username": "ubuntu",
      "ami_users": ["067402664595"]
    },
    {
      "name": "ingen-base-trusty64-ami",
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "ami_name": "ingen-base-trusty64-{{isotime \"2006-01-02T15-04-05MST\"}}",
      "ami_description": "Trusty64 image configured with https://github.com/ingenerator/ingen-base",
      "instance_type": "t2.large",
      "region": "eu-west-1",
      "source_ami": "{{user `source_ami_trusty64`}}",
      "ssh_username": "ubuntu",
      "ami_users": ["067402664595"]
    },
    {
      "name": "ingen-base-trusty64-droplet-lon",
      "type": "digitalocean",
      "api_token": "{{user `digitalocean_token`}}",
      "image":"ubuntu-14-04-x64",
      "region": "lon1",
      "size":"512mb",
      "snapshot_name": "ingen-base-trusty64-{{isotime \"2006-01-02T15-04-05MST\"}}",
      "state_timeout": "10m"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "provisioning",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "inline": [
        "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
      ],
      "only": [
        "ingen-base-trusty64-ami",
        "ingen-jenkins-trusty64"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "cd /tmp/provisioning",
        "ls -l",
        "chmod +x *.sh",
        "sudo ./bootstrap-instance.sh",
        "sudo ./cleanup-ubuntu.sh"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "cd /tmp/provisioning",
        "sudo ./bootstrap-jenkins-slave.sh"
      ],
      "only": [
        "ingen-jenkins-trusty64"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "sudo /tmp/provisioning/minimize.sh"
      ],
      "only": [
        "ingen-base-trusty64"
      ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "vagrant",
        "output": "{{.BuildName}}.{{user `version`}}.{{.Provider}}.box",
        "only": [
          "ingen-base-trusty64"
        ]
      }
    ]
  ]
}
